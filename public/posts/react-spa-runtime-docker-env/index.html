<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>为React单页应用提供Runtime运行时环境变量 | Alan Wang</title><meta name=keywords content><meta name=description content="使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。 比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。 本文主要解决在运行时提供环境变量的问题。 原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。
将如下env.sh文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js #!/bin/sh if [ $CONFIG_VARS ]; then # clear echo -n > ${CONFIG_FILE_PATH}/config.js SPLIT=$(echo $CONFIG_VARS | tr &#34;,&#34; &#34;\n&#34;) echo &#34;window."><meta name=author content><link rel=canonical href=http://wlchn.github.io/posts/react-spa-runtime-docker-env/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://wlchn.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://wlchn.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://wlchn.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://wlchn.github.io/apple-touch-icon.png><link rel=mask-icon href=http://wlchn.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="为React单页应用提供Runtime运行时环境变量"><meta property="og:description" content="使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。 比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。 本文主要解决在运行时提供环境变量的问题。 原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。
将如下env.sh文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js #!/bin/sh if [ $CONFIG_VARS ]; then # clear echo -n > ${CONFIG_FILE_PATH}/config.js SPLIT=$(echo $CONFIG_VARS | tr &#34;,&#34; &#34;\n&#34;) echo &#34;window."><meta property="og:type" content="article"><meta property="og:url" content="http://wlchn.github.io/posts/react-spa-runtime-docker-env/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-27T00:00:00+08:00"><meta property="article:modified_time" content="2019-03-27T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="为React单页应用提供Runtime运行时环境变量"><meta name=twitter:description content="使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。 比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。 本文主要解决在运行时提供环境变量的问题。 原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。
将如下env.sh文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js #!/bin/sh if [ $CONFIG_VARS ]; then # clear echo -n > ${CONFIG_FILE_PATH}/config.js SPLIT=$(echo $CONFIG_VARS | tr &#34;,&#34; &#34;\n&#34;) echo &#34;window."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://wlchn.github.io/posts/"},{"@type":"ListItem","position":2,"name":"为React单页应用提供Runtime运行时环境变量","item":"http://wlchn.github.io/posts/react-spa-runtime-docker-env/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"为React单页应用提供Runtime运行时环境变量","name":"为React单页应用提供Runtime运行时环境变量","description":"使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。 比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。 本文主要解决在运行时提供环境变量的问题。 原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。\n将如下env.sh文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js #!/bin/sh if [ $CONFIG_VARS ]; then # clear echo -n \u0026gt; ${CONFIG_FILE_PATH}/config.js SPLIT=$(echo $CONFIG_VARS | tr \u0026#34;,\u0026#34; \u0026#34;\\n\u0026#34;) echo \u0026#34;window.","keywords":[],"articleBody":"使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。 比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。 本文主要解决在运行时提供环境变量的问题。 原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。\n将如下env.sh文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js #!/bin/sh if [ $CONFIG_VARS ]; then # clear echo -n \u003e ${CONFIG_FILE_PATH}/config.js SPLIT=$(echo $CONFIG_VARS | tr \",\" \"\\n\") echo \"window._env = {\" \u003e\u003e ${CONFIG_FILE_PATH}/config.js for VAR in ${SPLIT}; do VALUE=$(printenv ${VAR}) echo \" ${VAR}: \\\"${VALUE}\\\",\" \u003e\u003e ${CONFIG_FILE_PATH}/config.js done echo \"}\" \u003e\u003e ${CONFIG_FILE_PATH}/config.js fi # disable broswer cache sed -i \"s/config.js?v=[0-9]*/config.js?v=$(date +'%s')/g\" /srv/http/index.html # for macOS # sed -i \"\" \"s/config.js?v=[0-9]*/config.js?v=$(date +'%s')/g\" /srv/http/index.html # exec CMD exec \"$@\" 例如\n# 传入 CONFIG_VARS=ABC,XYZ ABC=helloabc XYZ=HELLOXYZ # 转换为 window._env = { ABC: \"helloabc\", XYZ: \"HELLOXYZ\", } 编写 Dockerfile，使用 goStatic 当做静态文件服务器（比 nginx 轻量）。build 完成只有几 MB. FROM node:11 AS builder COPY . /app WORKDIR /app RUN yarn install RUN yarn run build FROM wlchn/gostatic:latest ENV CONFIG_FILE_PATH /srv/http COPY --from=builder /app/build /srv/http COPY ./env.sh /env.sh # Ensure convert envs to window._env ENTRYPOINT [\"sh\", \"/env.sh\"] # start server. listen on 8043(in container) by default. CMD [\"/goStatic\"] 在项目中引用 config.js 使用环境变量，通过window._env获取 let _env = process.env; // check if there is env exits in local, otherwise using window._env if (_env.ENV_ABC) { _env = window._env; } // so you can use env like _env.ENV_ABC 转换示例 # pass envs like: CONFIG_VARS=ABC,XYZ ABC=helloabc XYZ=HELLOXYZ # you coud get config.js window._env = { ABC: \"helloabc\", XYZ: \"HELLOXYZ\", } # in your app, you can use like console.log(_env.ABC) console.log(_env.XYZ) GitHub https://github.com/wlchn/docker-spa-env reference https://github.com/SocialEngine/docker-nginx-spa https://medium.freecodecamp.org/how-to-implement-runtime-environment-variables-with-create-react-app-docker-and-nginx-7f9d42a91d70 ","wordCount":"263","inLanguage":"en","datePublished":"2019-03-27T00:00:00+08:00","dateModified":"2019-03-27T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://wlchn.github.io/posts/react-spa-runtime-docker-env/"},"publisher":{"@type":"Organization","name":"Alan Wang","logo":{"@type":"ImageObject","url":"http://wlchn.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://wlchn.github.io/ accesskey=h title="Alan Wang (Alt + H)">Alan Wang</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://github.com//wlchn title=Github><span>Github</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>为React单页应用提供Runtime运行时环境变量</h1><div class=post-meta><span title='2019-03-27 00:00:00 +0800 CST'>March 27, 2019</span></div></header><div class=post-content><p>使用 create-react-app 创建的单页应用（SPA）是在 build 时注入环境变量的。一旦 build 成静态文件便不能动态提供环境变量了。
比如 build 一个单页应用的 docker image，可以在 build 时提供环境变量。但是已经 build 完成，使用 docker run 运行的时候不能再传递环境变量。
本文主要解决在运行时提供环境变量的问题。
原理：通过一段 shell 脚本将指定将 env 转换为 config.js 文件，该文件和 build 好的 static 文件 serve 在同一目录下，在应用中引用 config.js 文件，通过 window._env 获取环境变量。shell 脚本通过 docker image 的 entrypoint 执行。服务使用 go 构建的一个简单服务器，比 nginx 轻量很多。</p><ol><li>将如下<code>env.sh</code>文件拷问到项目目录下，在 entrypoint（docker run）时执行，作用是将环境变量转出 config.js</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $CONFIG_VARS <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># clear</span>
</span></span><span style=display:flex><span>  echo -n &gt; <span style=color:#e6db74>${</span>CONFIG_FILE_PATH<span style=color:#e6db74>}</span>/config.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  SPLIT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $CONFIG_VARS | tr <span style=color:#e6db74>&#34;,&#34;</span> <span style=color:#e6db74>&#34;\n&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;window._env = {&#34;</span> &gt;&gt; <span style=color:#e6db74>${</span>CONFIG_FILE_PATH<span style=color:#e6db74>}</span>/config.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> VAR in <span style=color:#e6db74>${</span>SPLIT<span style=color:#e6db74>}</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      VALUE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>printenv <span style=color:#e6db74>${</span>VAR<span style=color:#e6db74>}</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>      echo <span style=color:#e6db74>&#34;  </span><span style=color:#e6db74>${</span>VAR<span style=color:#e6db74>}</span><span style=color:#e6db74>: \&#34;</span><span style=color:#e6db74>${</span>VALUE<span style=color:#e6db74>}</span><span style=color:#e6db74>\&#34;,&#34;</span> &gt;&gt; <span style=color:#e6db74>${</span>CONFIG_FILE_PATH<span style=color:#e6db74>}</span>/config.js
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;}&#34;</span> &gt;&gt; <span style=color:#e6db74>${</span>CONFIG_FILE_PATH<span style=color:#e6db74>}</span>/config.js
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># disable broswer cache</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/config.js?v=[0-9]*/config.js?v=</span><span style=color:#66d9ef>$(</span>date +<span style=color:#e6db74>&#39;%s&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>/g&#34;</span> /srv/http/index.html
</span></span><span style=display:flex><span><span style=color:#75715e># for macOS</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sed -i &#34;&#34; &#34;s/config.js?v=[0-9]*/config.js?v=$(date +&#39;%s&#39;)/g&#34; /srv/http/index.html</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># exec CMD</span>
</span></span><span style=display:flex><span>exec <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>例如</p><pre tabindex=0><code># 传入
CONFIG_VARS=ABC,XYZ
ABC=helloabc
XYZ=HELLOXYZ

# 转换为
window._env = {
  ABC: &#34;helloabc&#34;,
  XYZ: &#34;HELLOXYZ&#34;,
}
</code></pre><ol start=2><li>编写 Dockerfile，使用 goStatic 当做静态文件服务器（比 nginx 轻量）。build 完成只有几 MB.</li></ol><pre tabindex=0><code>FROM node:11 AS builder
COPY . /app
WORKDIR /app
RUN yarn install
RUN yarn run build

FROM wlchn/gostatic:latest
ENV CONFIG_FILE_PATH /srv/http
COPY --from=builder /app/build /srv/http
COPY ./env.sh /env.sh
# Ensure convert envs to window._env
ENTRYPOINT [&#34;sh&#34;, &#34;/env.sh&#34;]
# start server. listen on 8043(in container) by default.
CMD [&#34;/goStatic&#34;]
</code></pre><ol start=3><li>在项目中引用 config.js</li></ol><pre tabindex=0><code>&lt;script type=&#34;text/javascript&#34; src=&#34;/config.js?v=&#34;&gt;&lt;/script&gt;
</code></pre><ol start=4><li>使用环境变量，通过<code>window._env</code>获取</li></ol><pre tabindex=0><code>let _env = process.env;
// check if there is env exits in local, otherwise using window._env
if (_env.ENV_ABC) {
  _env = window._env;
}
// so you can use env like _env.ENV_ABC
</code></pre><ol start=5><li>转换示例</li></ol><pre tabindex=0><code># pass envs like:
CONFIG_VARS=ABC,XYZ
ABC=helloabc
XYZ=HELLOXYZ

# you coud get config.js
window._env = {
  ABC: &#34;helloabc&#34;,
  XYZ: &#34;HELLOXYZ&#34;,
}

# in your app, you can use like
console.log(_env.ABC)
console.log(_env.XYZ)
</code></pre><h2 id=github>GitHub<a hidden class=anchor aria-hidden=true href=#github>#</a></h2><ul><li><a href=https://github.com/wlchn/docker-spa-env>https://github.com/wlchn/docker-spa-env</a></li></ul><h2 id=reference>reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://github.com/SocialEngine/docker-nginx-spa>https://github.com/SocialEngine/docker-nginx-spa</a></li><li><a href=https://medium.freecodecamp.org/how-to-implement-runtime-environment-variables-with-create-react-app-docker-and-nginx-7f9d42a91d70>https://medium.freecodecamp.org/how-to-implement-runtime-environment-variables-with-create-react-app-docker-and-nginx-7f9d42a91d70</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://wlchn.github.io/>Alan Wang</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>